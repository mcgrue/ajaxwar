<html>
  <head>
    <title>AjaxWar Battle</title>
    <style type="text/css">
      body { margin: 0px; padding: 20px; font-family: verdana; }
      #screen { width: 100%; height: 100%; background: url(/static/loading.gif) white no-repeat center;}
      .box { width: 50px; height: 50px; position: absolute; }
      .chat { font-size: small; width: 150px; position: relative; bottom: 100px; height: 100px;}
      /*.chat .wrap { position: absolute; bottom: 0px;}*/
      form { position: absolute; bottom: 5px; left: 24px; width: 95%; display: inline;}
      input { width: 95%; border: 0px; font-size: 14px;}
    </style>
    <link rel="stylesheet" href="static/style.css" type="text/css" />
    <script type="text/javascript" src="http://github.com/DmitryBaranovskiy/raphael/blob/master/raphael-min.js?raw=true"></script>
    <script type="text/javascript" src="http://www.twiliort.com/v1/realtime-client.js"></script>
    <script type="text/javascript" src="/static/js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui-1.8.4.custom.min.js"></script>
    <script type="text/javascript" src="/static/js/lobby.js"></script>
    <script type="text/javascript" src="/static/js/util.js"></script>
    <script type="text/javascript" src="/static/js/ajaxwar.js"></script>
    <script type="text/javascript">
      var game = null;
      var lobby = null;
      var color = null;
            
      var Game = function(playerCount, clientId, isHost) {
        this.isHost = isHost;
        this.playerCount = playerCount;
        this.clientId = clientId;
        this.remotes = [];
        this.nicks = {};
      }
      Game.prototype = {
        send: function(type, data) {
          if (!data) data = {};
          data['type'] = type;
          data['client'] = this.clientId;
          $.post('?send', data);
        },
        
        receive: function(message) {
          if (message.client != this.clientId) {
            try {
              this['on'+message.type](message);
            } catch(e) {
              console.error('no handler for '+message.type);
            }
          }
        },
        
        onjoin: function(event) {
          if (this.isHost) {
            this.send('playing');
          }
        },
        
        start: function() { 
          console.log("Starting game...");
          $('#screen').css('background-image', 'none');
          $('form input').focus();
          AjaxWar.init('screen', color);
          //$.post('?send', {type: 'enter', player: this.player}); 
        },
        
        isRemote: function(id) { 
          return (this.remotes.indexOf(id) != -1);
        },
        
        onenter: function(event) {
          if (!this.isRemote(event.player)) {
            this.createRemote(event.player);
            if (this.isHost) { 
              // Enslave them
              $.post('?send', {type: 'enslave', player: this.player});
            }
          }
        },
        
        
        createRemote: function(id) {
          console.log("Player '"+id+"' joined");
          this.remotes.push(id);
        },
        
        sendChat: function(chat) {
          this.send('chat', {chat: chat});
        },
        
        onchat: function(event) {
          var nick = (this.nicks.hasOwnProperty(event.client)) ? this.nicks[event.client] : event.client;
          console.log(nick+": "+event.chat);
          displayChat(nick, event.chat);
        },
        
        setNick: function(nick) {
          this.nicks[this.clientId] = nick;
          this.send('nick', {'nick': nick});
        },
        
        onnick: function(event) {
          var nick = (this.nicks.hasOwnProperty(event.client)) ? this.nicks[event.client] : event.client;
          displayChat(nick, ": changed name to "+event.nick);
          this.nicks[event.client] = event.nick;
        },
      };
      
      $(document).ready(function() {
        color = setupColor();
        lobby = new Lobby(2, function() { 
          game = new Game(lobby.size, lobby.clientId, lobby.isHost);
          game.start();
        });
        
        Realtime.init("{{account_sid}}", {accessToken: "{{access_token}}"});
        Realtime.listen("/{{battle}}", {
          onconnect: function() {
            lobby.join();
          },
          ondisconnect: function() {
            console.error("disconnected.");
          },
          onerror: function(reason) {
            console.error(reason);
          },
          onmessage: function(msg) {
            if (lobby.state == 'playing') {
              game.receive(msg);
            } else {
              lobby.receive(msg);
            }
          },
        });

        
      })
      
      function setupColor() {
        function colorByte() { return (rnd(128)+64).toString(16); }
        color = colorByte() + colorByte() + colorByte();
        $('body').css('background', '#'+color);
        return color;
      }
      
      
      function getNormalPosition(id) {
        return normalizePosition($('#'+id)[0])
      }
      
      function setNormalPosition(id, x, y) {
        var pos = denormalizePosition(x, y);
        $('#'+id).css('left', pos.x);
        $('#'+id).css('top', pos.y);
      }
      
      function displayChat(id, text) {
        var chatId = 'chat-' + Date.now().toString();
        $('#chat').append('<div id="'+chatId+'">'+id+': '+text+'</div>');
        setTimeout(function(){ $('#'+chatId).remove(); }, 5000);
      }
      
      function sendChat() {
        var chat = $('input').val();
        if (chat.indexOf("/nick ") != -1) {
          var nick = chat.split(' ')[1];
          console.log("setting nick: "+nick);
          game.setNick(nick);
        } else {
          displayChat('me', chat);
          console.log("me: "+chat);
          game.sendChat(chat);
        }
        $('input').val('');
        return false;
      }
      
      
      function normalizePosition(el) { 
        return {x: el.offsetLeft/$('body')[0].offsetWidth, y: el.offsetTop/$('body')[0].offsetHeight} }
      function denormalizePosition(x,y) {
        return {x: x * $('body')[0].offsetWidth, y: y * $('body')[0].offsetHeight}
      }

    </script>
  </head>
  <body onclick="$('input').focus()">
    <div id="button_indicator">
        <div id="tank_indicator" class="tank indicator"></div>
        <div id="production_indicator" class="production indicator"></div>
        <div id="tower_indicator" class="tower indicator"></div>
    </div>
    <div id="screen">
      <div id="chat"></div>
    </div>
    <form onsubmit="return sendChat()"><input type="text" /></form>
  </body>
</html>