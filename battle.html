<html>
  <head>
    <title>AjaxWar Battle</title>
    <style type="text/css">
      body { margin: 0px; padding: 20px; font-family: verdana; }
      #screen { width: 100%; height: 100%; background: url(/static/loading.gif) white no-repeat center;
        position: relative;
        overflow:  hidden;}
      .box { width: 50px; height: 50px; position: absolute; }
      #text { top: 20px; position: absolute; list-style-type: square;}
      .chat { font-size: small; width: 150px; position: relative; bottom: 100px; height: 100px;}
      /*.chat .wrap { position: absolute; bottom: 0px;}*/
      form { position: absolute; bottom: 5px; left: 24px; width: 95%; display: inline;}
      input { width: 95%; border: 0px; font-size: 14px;}
    </style>
    <link rel="stylesheet" href="static/style.css" type="text/css" />
    <script type="text/javascript" src="http://github.com/DmitryBaranovskiy/raphael/blob/master/raphael-min.js?raw=true"></script>
    <script type="text/javascript" src="http://www.twiliort.com/v1/realtime-client.js"></script>
    <script type="text/javascript" src="/static/js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui-1.8.4.custom.min.js"></script>
    <script type="text/javascript" src="/static/js/lobby.js"></script>
    <script type="text/javascript" src="/static/js/util.js"></script>
    <script type="text/javascript" src="/static/js/ajaxwar.js"></script>
    <script type="text/javascript">
      var TIMEOUT = 5000;
      var game = null;
      var lobby = null;
      var state = 'lobby';
      var color = null;
            
      var Player = function(id, color, remote, nick) {
        this.remote = remote;
        this.id = id;
        this.nick = nick;
        this.color = color;
        this.units = [];
      }
      Player.prototype = {
        getName: function() {
          return (this.nick) ? this.nick : this.id;
        },
        createUnit: function(id, type, x, y) {
          var unit = new AjaxWar.Unit(id, type, x, y, this);
          this.units.push(unit);
          return unit;
        },
      }
            
      var Game = function(playerCount, clientId, isHost) {
        this.isHost = isHost;
        this.playerCount = playerCount;
        this.clientId = clientId;
        this.players = {};
      }
      Game.prototype = {
        send: function(type, data) {
          if (!data) data = {};
          data['type'] = 'game:'+type;
          data['client'] = this.clientId;
          $.ajaxSetup({contentType: 'application/json'});
          $.post('?send', JSON.stringify(data));
        },
        
        receive: function(message) {
          if (message.client != this.clientId) {
            try {
              this['on'+message.type.split(':')[1]](message);
            } catch(e) {
              console.error('no handler for '+message.type);
            }
          }
        },
        
        getPlayer: function() {
          return this.players[this.clientId];
        },
        
        
        // if somebody tries to join when playing, we tell them to bugger off
        onjoin: function(event) {
          if (this.isHost) {
            this.send('playing');
          }
        },
        
        start: function() { 
          displayText("Starting game...");
          $('#screen').css('background-image', 'none');
          AjaxWar.init('screen', color, this);
          this.send('enter', {color: color});
          this.createPlayer(this.clientId, color, false);
        },
        
        
        onenter: function(event) {
          if (!this.hasOwnProperty(event.client) && len(this.players) < this.playerCount) {
            this.createPlayer(event.client, event.color, true);
          }
          if (len(this.players) == this.playerCount && this.isHost) {
            var startingCorners = [[10,10], [60,10], [10, 60], [60,60]];
            var location = null, unit = null, locations = {};
            for (var i in this.players) {
              location = startingCorners.splice(rnd(startingCorners.length), 1)[0];
              location = denormalizePosition((location[0] + rnd(30))/100, (location[1] + rnd(30))/100);
              unit = this.players[i].createUnit(AjaxWar.getNextRef(), 'production', location.x, location.y);
              locations[i] = unit.serialize();
            }
            this.send('start', {'locations': locations});
          }
        },
        
        onstart: function(event) {
          for (var i in event.locations) {
            this.players[i].createUnit(
              event.locations[i].id, 
              event.locations[i].type, 
              event.locations[i].x, 
              event.locations[i].y);
          }
        },
        
        onunitcreate: function(event) {
          this.players[event.client].createUnit(event.unit.id, event.unit.type, event.unit.x, event.unit.y);
        },
        
        onunitmove: function(event) {
          var unit = AjaxWar.getUnitById(event.unit.id);
          unit.move(event.x, event.y);
        },
        
        
        createPlayer: function(id, color, remote) {
          displayText("Player '"+id+"' joined");
          this.players[id] = new Player(id, color, remote);
        },
        
        sendChat: function(chat) {
          this.send('chat', {chat: chat});
        },
        
        onchat: function(event) {
          displayChat(this.players[event.client], event.chat);
        },
        
        setNick: function(nick) {
          this.players[this.clientId].nick = nick;
          this.send('nick', {'nick': nick});
        },
        
        onnick: function(event) {
          var player = this.players[event.client];
          displayText(player.getName() + " changed name to "+event.nick);
          player.nick = nick;
        },
      };
      
      $(document).ready(function() {
        color = setupColor();
        lobby = new Lobby(2, function() { 
          game = new Game(lobby.size, lobby.clientId, lobby.isHost);
          state = 'game';
          game.start();
        });
        
        Realtime.init("{{account_sid}}", {accessToken: "{{access_token}}"});
        Realtime.listen("/{{battle}}", {
          onconnect: function() {
            lobby.join();
          },
          ondisconnect: function() {
            console.error("disconnected.");
          },
          onerror: function(reason) {
            console.error(reason);
          },
          onmessage: function(msg) {
            if (state == 'lobby' && msg.type.split(':')[0] == 'lobby') {
              lobby.receive(msg);
            } else if (state == 'game' && msg.type.split(':')[0] == 'game') {
              game.receive(msg);
            }
          },
        });

        
      })
      
      function setupColor() {
        function colorByte() { return (rnd(128)+64).toString(16); }
        color = colorByte() + colorByte() + colorByte();
        $('body').css('background', '#'+color);
        return color;
      }
      
      
      function getNormalPosition(id) {
        return normalizePosition($('#'+id)[0])
      }
      
      function setNormalPosition(id, x, y) {
        var pos = denormalizePosition(x, y);
        $('#'+id).css('left', pos.x);
        $('#'+id).css('top', pos.y);
      }
      
      function displayChat(player, text) {
        displayText(player.getName() + ': ' + text, player.color);
      }
      
      function displayText(text, color) {
        if (!color) color = 'black';
        var textId = 'text-' + Date.now().toString();
        $('#text').append('<li id="'+textId+'" style="color: '+color+';"><span style="color: black;">'+text+'</span></li>');
        console.log(text);
        setTimeout(function(){ $('#'+textId).remove(); }, 5000);
      }
      
      function sendChat() {
        var chat = $('input').val();
        if (chat.indexOf("/nick ") != -1) {
          var nick = chat.split(' ')[1];
          console.log("setting nick: "+nick);
          game.setNick(nick);
        } else {
          displayText('me: ' + chat);
          game.sendChat(chat);
        }
        $('input').val('');
        return false;
      }
      
      
      function normalizePosition(el) { 
        return {x: el.offsetLeft/$('body')[0].offsetWidth, y: el.offsetTop/$('body')[0].offsetHeight} }
      function denormalizePosition(x,y) {
        return {x: x * $('body')[0].offsetWidth, y: y * $('body')[0].offsetHeight}
      }

    </script>
  </head>
  <body onclick="$('input').focus()">
    <div id="screen">
      <ul id="text"></ul>
    </div>
    <form onsubmit="sendChat(); return false;"><input type="text" /></form>
  </body>
</html>